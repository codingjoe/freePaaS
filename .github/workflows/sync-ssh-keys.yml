name: Sync SSH Keys
on:
  schedule:
    - cron: '0 * * * *' # Sync hourly
  workflow_dispatch: # Allow manual trigger
concurrency:
  group: sync-ssh-keys
  cancel-in-progress: true
permissions:
  contents: read
jobs:
  sync-keys:
    name: Sync SSH keys to production
    runs-on: ubuntu-latest
    environment:
      name: production
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Get repository collaborators
        id: get-collaborators
        run: |
          echo "::group::Fetching collaborators"
          echo "::debug::Fetching collaborators for ${{ github.repository }}"

          # Get all collaborators with push access or higher
          collaborators=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/collaborators" \
            --jq '.[] | select(.permissions.push == true or .permissions.admin == true) | .login')

          if [ -z "$collaborators" ]; then
            echo "::error::No collaborators found with push/admin access"
            exit 1
          fi

          echo "::debug::Found collaborators:"
          echo "$collaborators"

          # Save to file
          echo "$collaborators" > /tmp/collaborators.txt

          collaborator_count=$(echo "$collaborators" | wc -l)
          echo "::debug::Total collaborators with push/admin access: $collaborator_count"
          echo "::endgroup::"
      - name: Fetch SSH keys for collaborators
        id: fetch-keys
        run: |
          echo "::group::Fetching SSH keys"

          # Initialize authorized_keys file
          > /tmp/authorized_keys

          # Read collaborators and fetch their SSH keys
          while IFS= read -r username; do
            if [ -n "$username" ]; then
              echo "::debug::Fetching SSH keys for $username..."

              # Fetch SSH keys from GitHub
              keys=$(gh api \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/users/$username/keys" \
                --jq '.[].key' 2>/dev/null || true)
              if [ -n "$keys" ]; then
                key_count=$(echo "$keys" | wc -l)
                echo "::debug::Found $key_count SSH key(s) for $username"

                # Add each key with command restriction
                while IFS= read -r key; do
                  if [ -n "$key" ]; then
                    echo "command=\"docker system dial-stdio\",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty $key $username" >> /tmp/authorized_keys
                  fi
                done <<< "$keys"
                echo "" >> /tmp/authorized_keys
              else
                echo "::warning::No SSH keys found for $username"
              fi
            fi
          done < /tmp/collaborators.txt

          # Validate that we have at least one key
          if [ ! -s /tmp/authorized_keys ]; then
            echo "::error::No SSH keys found for any collaborators"
            exit 1
          fi

          echo "::debug::Generated authorized_keys file:"
          cat /tmp/authorized_keys

          # Count keys
          key_count=$(grep -c "^command=" /tmp/authorized_keys || true)
          echo "::debug::Total SSH keys to sync: $key_count"
          echo "::endgroup::"
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Upload authorized_keys to remote host
        env:
          SSH_USER: ${{ secrets.DOCKER_PRODUCTION_SSH_USER }}
          SSH_HOST: ${{ secrets.DOCKER_PRODUCTION_SSH_HOST }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          echo "::group::Uploading SSH keys to remote host"
          echo "::debug::Syncing SSH keys to $SSH_USER@$SSH_HOST"

          # Write directly to remote file
          scp /tmp/authorized_keys $SSH_USER@$SSH_HOST:/tmp/authorized_keys && ssh $SSH_USER@$SSH_HOST "sudo mv /tmp/authorized_keys /home/collaborator/.ssh/authorized_keys && sudo chown collaborator:collaborator /home/collaborator/.ssh/authorized_keys && sudo chmod 600 /home/docker/.ssh/authorized_keys"

          echo "::notice::âœ“ SSH keys synced to docker user on $SSH_HOST"
          echo "::endgroup::"
      - name: Verify authorized_keys
        env:
          SSH_USER: ${{ secrets.DOCKER_PRODUCTION_SSH_USER }}
          SSH_HOST: ${{ secrets.DOCKER_PRODUCTION_SSH_HOST }}
        run: |
          echo "::group::Verifying authorized_keys on remote host"
          echo "::debug::Current authorized_keys on remote host:"
          ssh "$SSH_USER@$SSH_HOST" "sudo cat /home/docker/.ssh/authorized_keys"

          remote_key_count=$(ssh "$SSH_USER@$SSH_HOST" "sudo grep -c '^command=' /home/docker/.ssh/authorized_keys" || true)
          echo "::notice::Total keys on remote host: $remote_key_count"
          echo "::endgroup::"
