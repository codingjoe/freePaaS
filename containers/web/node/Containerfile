FROM debian:bookworm AS build
LABEL authors="codingjoe"

ENV N_PREFIX=/opt/nodejs
ENV PATH=$N_PREFIX/bin:$PATH
ARG NODE_ENV=production
ENV NODE_ENV=$NODE_ENV

# Install dependencies
COPY ../../../Aptfile /tmp
RUN cd /tmp && apt update && cat Aptfile | xargs apt download \
    && mkdir -p /dpkg && \
    for deb in *.deb; do dpkg --extract $deb /dpkg || exit 10; done

RUN apt install -y curl git build-essential

WORKDIR /app
COPY ../../../.nvmrc /app/.nvmrc
RUN curl -fsSL https://raw.githubusercontent.com/tj/n/master/bin/n | bash -s install --cleanup auto
RUN mkdir node_modules # In case there are no dependencies
RUN --mount=type=cache,target=/app/node_modules --mount=type=bind,source=../../../package-lock.json,target=package-lock.json --mount=type=bind,source=../../../package.json,target=package.json npm ci
COPY .. /app
RUN --mount=type=cache,target=/app/node_modules npm ci

FROM gcr.io/distroless/cc:nonroot AS development

# Copy binary dependencies
COPY --from=build /dpkg /

# Copy Node dependencies
COPY --from=build --chown=nodejs:nodejs /opt/nodejs /opt/nodejs
COPY --from=build --chown=nodejs:nodejs /app/node_modules /opt/node_modules

ENV NODE_PATH=/opt/node_modules
ENV PATH="/opt/nodejs/bin:$PATH"

EXPOSE 8000

WORKDIR /app

ENTRYPOINT ["node"]

FROM development AS production

COPY .. /app
